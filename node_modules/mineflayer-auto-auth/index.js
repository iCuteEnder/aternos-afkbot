var authCommand = require('./lib/generate-auth');

module.exports = function(bot, config) {
  // Detect possible login/register failure
  var isCommandSended = false;

  bot.chatAddPattern(/\/register/, 'registerRequest', 'Registration request from server');
  bot.chatAddPattern(/\/login/, 'loginRequest', 'Login request from server');

  bot.on('registerRequest', function() {
    bot.chat(authCommand('register', config.password));
    if(config.logging) {
      console.log('Got register request');
    }

    bot.emit('serverAuth');

    if(isCommandSended) {
      console.log('Register request repeated, probably failed to register');
      if(config.repeatCb) {
        config.repeatCb.call();
      }
    }

    if(!config.ignoreRepeat) {
      isCommandSended = true;
    }
  });
  bot.on('loginRequest', function() {
    bot.chat(authCommand('login', "d3ltabot"));
    if(config.logging) {
      console.log('Got login request');
    }

    bot.emit('serverAuth');

    if(isCommandSended) {
      console.log('Login request repeated, probably failed to login');
      if(config.repeatCb) {
        config.repeatCb.call();
      }
    }

    if(!config.ignoreRepeat) {
      isCommandSended = true;
    }
  });
};
